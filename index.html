<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apps Store Az - Tu Tienda de Apps</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {margin:0;padding:0;box-sizing:border-box;}
        body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333;}
        .container {max-width:1200px;margin:0 auto;padding:20px;}
        .header {background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-radius:20px;padding:20px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
        .logo {font-size:2rem;font-weight:bold;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:10px;}
        .auth-buttons {display:flex;gap:10px;align-items:center;}
        .btn {padding:12px 24px;border:none;border-radius:25px;cursor:pointer;font-weight:600;transition:all 0.3s ease;text-decoration:none;display:inline-flex;align-items:center;gap:8px;}
        .btn-primary {background:linear-gradient(135deg,#667eea,#764ba2);color:white;}
        .btn-secondary {background:rgba(102,126,234,0.1);color:#667eea;border:2px solid #667eea;}
        .btn:hover {transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2);}
        .btn:disabled {opacity:0.6;cursor:not-allowed;transform:none;}
        .search-section {background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-radius:20px;padding:20px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,0.1);}
        .search-bar {display:flex;gap:15px;flex-wrap:wrap;align-items:center;}
        .search-input {flex:1;min-width:300px;padding:15px 20px;border:2px solid #e0e0e0;border-radius:25px;font-size:16px;transition:all 0.3s ease;}
        .search-input:focus {outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);}
        .category-filter {padding:12px 20px;border:2px solid #e0e0e0;border-radius:25px;background:white;cursor:pointer;}
        .apps-section {background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.1);}
        .section-title {font-size:2rem;margin-bottom:30px;text-align:center;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        .apps-grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:25px;margin-bottom:30px;}
        .app-card {background:white;border-radius:20px;padding:25px;box-shadow:0 5px 20px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;border:2px solid transparent;}
        .app-card:hover {transform:translateY(-5px);box-shadow:0 15px 40px rgba(0,0,0,0.15);border-color:#667eea;}
        .app-header {display:flex;align-items:center;gap:15px;margin-bottom:15px;}
        .app-icon {width:60px;height:60px;border-radius:15px;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;font-size:24px;}
        .app-info h3 {font-size:1.2rem;margin-bottom:5px;color:#333;}
        .app-category {background:rgba(102,126,234,0.1);color:#667eea;padding:4px 12px;border-radius:15px;font-size:0.8rem;font-weight:600;}
        .app-description {color:#666;margin-bottom:20px;line-height:1.5;}
        .app-stats {display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
        .stat {display:flex;align-items:center;gap:5px;color:#888;font-size:0.9rem;}
        .download-btn {width:100%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:12px;border-radius:15px;cursor:pointer;font-weight:600;transition:all 0.3s ease;}
        .download-btn:hover {transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,0.3);}
        .modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);backdrop-filter:blur(5px);z-index:1000;justify-content:center;align-items:center;}
        .modal-content {background:white;border-radius:20px;padding:30px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;position:relative;}
        .close-modal {position:absolute;top:15px;right:20px;background:none;border:none;font-size:24px;cursor:pointer;color:#888;}
        .form-group {margin-bottom:20px;}
        .form-group label {display:block;margin-bottom:8px;font-weight:600;color:#333;}
        .form-group input,.form-group textarea,.form-group select {width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;transition:border-color 0.3s ease;}
        .form-group input:focus,.form-group textarea:focus,.form-group select:focus {outline:none;border-color:#667eea;}
        .upload-area {border:2px dashed #667eea;border-radius:10px;padding:30px;text-align:center;cursor:pointer;transition:all 0.3s ease;position:relative;}
        .upload-area:hover {background:rgba(102,126,234,0.05);}
        .upload-area.dragover {background:rgba(102,126,234,0.1);border-color:#764ba2;}
        .upload-area.has-file {border-color:#2ed573;background:rgba(46,213,115,0.05);}
        .file-info {margin-top:10px;padding:10px;background:rgba(46,213,115,0.1);border-radius:8px;color:#2ed573;font-size:14px;}
        .user-profile {display:none;align-items:center;gap:15px;}
        .user-avatar {width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;}
        .admin-panel {display:none;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;margin-top:30px;box-shadow:0 10px 30px rgba(0,0,0,0.1);}
        .admin-apps {display:grid;gap:15px;}
        .admin-app-item {display:flex;align-items:center;justify-content:space-between;padding:15px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
        .admin-app-info {display:flex;align-items:center;gap:15px;}
        .admin-actions {display:flex;gap:10px;}
        .btn-danger {background:#ff4757;color:white;}
        .btn-warning {background:#ffa502;color:white;}
        .btn-success {background:#2ed573;color:white;}
        .progress-bar {width:100%;height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden;margin:10px 0;}
        .progress-fill {height:100%;background:linear-gradient(135deg,#667eea,#764ba2);transition:width 0.3s ease;border-radius:4px;}
        .upload-status {text-align:center;margin:15px 0;font-weight:600;}
        @media (max-width:768px){.header{flex-direction:column;gap:20px;text-align:center;}.search-bar{flex-direction:column;}.search-input{min-width:100%;}.apps-grid{grid-template-columns:1fr;}.logo{font-size:1.5rem;}}
        .loading {display:flex;justify-content:center;align-items:center;padding:50px;}
        .spinner {width:40px;height:40px;border:4px solid #e0e0e0;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;}
        @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
        .notification {position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:10px;color:white;font-weight:600;z-index:1001;transform:translateX(400px);transition:transform 0.3s ease;max-width:350px;}
        .notification.show {transform:translateX(0);}
        .notification.success {background:#2ed573;}
        .notification.error {background:#ff4757;}
        .notification.info {background:#3742fa;}
        .error-details {background:rgba(255,255,255,0.95);border-radius:15px;padding:20px;margin:20px 0;border-left:4px solid #ff4757;}
        .debug-info {font-family:monospace;background:#f8f9fa;padding:10px;border-radius:5px;font-size:12px;margin-top:10px;}
        .stats-bar {display:flex;justify-content:center;gap:30px;margin-bottom:20px;flex-wrap:wrap;}
        .stat-item {text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:10px;color:white;min-width:120px;}
        .stat-value {font-size:1.5rem;font-weight:bold;display:block;}
        .offline-mode {background:rgba(255,193,7,0.9);color:#856404;padding:10px;text-align:center;border-radius:10px;margin-bottom:20px;}
        
        @media (max-width: 480px) {
            .admin-app-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .admin-actions {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }
            .admin-actions .btn {
                width: 100%;
                justify-content: center;
            }
            .modal-content {
                padding: 20px;
            }
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            .section-title {
                font-size: 1.8rem;
            }
            .header {
                padding: 15px;
            }
            .search-section {
                padding: 15px;
            }
            .apps-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Offline indicator -->
        <div class="offline-mode" id="offlineMode" style="display: none;">
            <i class="fas fa-wifi"></i> Modo sin conexión - Funcionalidad limitada
        </div>

        <!-- Header -->
        <div class="header">
            <div class="logo">
                <img src="https://i.ibb.co/B2Nbx0Zd/Whats-App-Image-2025-07-24-at-3-51-53-PM.jpg" alt="Apps Store Az Logo" style="height: 40px; border-radius: 5px;">
                Apps Store Az
            </div>
            <div class="auth-buttons" id="authButtons">
                <button class="btn btn-secondary" onclick="showLoginModal()">
                    <i class="fas fa-sign-in-alt"></i>
                    Iniciar Sesión
                </button>
                <button class="btn btn-primary" onclick="showRegisterModal()" style="display: none;">
                    <i class="fas fa-user-plus"></i>
                    Registrarse
                </button>
            </div>
            <div class="user-profile" id="userProfile">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">Usuario</span>
                <button class="btn btn-primary" onclick="showUploadModal()">
                    <i class="fas fa-upload"></i>
                    Subir APK
                </button>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Salir
                </button>
            </div>
        </div>

        <!-- Statistics Bar -->
        <div class="stats-bar" id="statsBar" style="display: none;">
            <div class="stat-item">
                <span class="stat-value" id="totalApps">0</span>
                <span>Apps Aprobadas</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="totalDownloads">0</span>
                <span>Descargas Totales</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="totalUsers">0</span>
                <span>Usuarios</span>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="search-section">
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Buscar aplicaciones..." id="searchInput">
                <select class="category-filter" id="categoryFilter">
                    <option value="">Todas las categorías</option>
                    <option value="Juegos">Juegos</option>
                    <option value="Productividad">Productividad</option>
                    <option value="Entretenimiento">Entretenimiento</option>
                    <option value="Educación">Educación</option>
                    <option value="Fotografía">Fotografía</option>
                    <option value="Redes Sociales">Redes Sociales</option>
                    <option value="Herramientas">Herramientas</option>
                    <option value="Otros">Otros</option>
                </select>
                <button class="btn btn-primary" onclick="searchApps()">
                    <i class="fas fa-search"></i>
                    Buscar
                </button>
                <button class="btn btn-secondary" onclick="clearSearch()">
                    <i class="fas fa-times"></i>
                    Limpiar
                </button>
            </div>
        </div>


        <!-- Apps Section -->
        <div class="apps-section">
            <h2 class="section-title">Aplicaciones Disponibles</h2>
            <div class="apps-grid" id="appsGrid">
                <!-- Apps will be loaded here -->
            </div>
        </div>

        <!-- Admin Panel -->
        <div class="admin-panel" id="adminPanel">
            <h2 class="section-title">Panel de Administración</h2>
            <div class="admin-apps" id="adminApps"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('loginModal')">&times;</button>
            <h2>Iniciar Sesión</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Contraseña:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i>
                    Iniciar Sesión
                </button>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('registerModal')">&times;</button>
            <h2>Registrarse</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label>Nombre:</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label>Contraseña:</label>
                    <input type="password" id="registerPassword" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-user-plus"></i>
                    Registrarse
                </button>
            </form>
        </div>
    </div>

    <!-- Upload APK Modal -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('uploadModal')">&times;</button>
            <h2>Subir Nueva Aplicación</h2>
            <form id="uploadForm">
                <div class="form-group">
                    <label>Nombre de la App: <span style="color: red;">*</span></label>
                    <input type="text" id="appName" required maxlength="100">
                </div>
                <div class="form-group">
                    <label>Descripción: <span style="color: red;">*</span></label>
                    <textarea id="appDescription" rows="4" required maxlength="500" placeholder="Describe tu aplicación (máximo 500 caracteres)"></textarea>
                </div>
                <div class="form-group">
                    <label>Categoría: <span style="color: red;">*</span></label>
                    <select id="appCategory" required>
                        <option value="">Seleccionar categoría</option>
                        <option value="Juegos">Juegos</option>
                        <option value="Productividad">Productividad</option>
                        <option value="Entretenimiento">Entretenimiento</option>
                        <option value="Educación">Educación</option>
                        <option value="Fotografía">Fotografía</option>
                        <option value="Redes Sociales">Redes Sociales</option>
                        <option value="Herramientas">Herramientas</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Versión: <span style="color: red;">*</span></label>
                    <input type="text" id="appVersion" placeholder="ej: 1.0.0" required>
                </div>
                <div class="form-group">
                    <label>Icono de la App: (Opcional)</label>
                    <div class="upload-area" id="iconUploadArea" onclick="triggerFileInput('iconFile')">
                        <i class="fas fa-image" style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
                        <p>Haz clic para seleccionar el icono</p>
                        <small>PNG, JPG, WEBP - Máximo 2MB</small>
                    </div>
                    <input type="file" id="iconFile" accept="image/*" style="display: none;">
                    <div id="iconFileInfo" class="file-info" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label>Archivo APK: <span style="color: red;">*</span></label>
                    <div class="upload-area" id="apkUploadArea" onclick="triggerFileInput('apkFile')">
                        <i class="fas fa-file-archive" style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
                        <p>Haz clic para seleccionar el archivo APK</p>
                        <small>Solo archivos .apk - Máximo 50MB</small>
                    </div>
                    <input type="file" id="apkFile" accept=".apk" style="display: none;" required>
                    <div id="apkFileInfo" class="file-info" style="display: none;"></div>
                </div>
                
                <!-- Progress Bar -->
                <div id="uploadProgress" style="display: none;">
                    <div class="upload-status" id="uploadStatus">Preparando subida...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" id="uploadBtn" style="width: 100%;">
                    <i class="fas fa-upload"></i>
                    Subir Aplicación
                </button>
            </form>
        </div>
    </div>

    <!-- App Detail Modal -->
    <div class="modal" id="appDetailModal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-modal" onclick="closeModal('appDetailModal')">&times;</button>
            <div id="appDetailContent"></div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDtEV4B00LzmUJScBxhQ4Gh_cO7RmUSt3M",
  authDomain: "bace-datos.firebaseapp.com",
  projectId: "bace-datos",
  storageBucket: "bace-datos.firebasestorage.app",
  messagingSenderId: "392224921438",
  appId: "1:392224921438:web:6222052d04d79b98f1e1cf",
  measurementId: "G-B5R5DK66FE"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let currentUser = null;
let allApps = [];
let uploadInProgress = false;

// Main initialization
document.addEventListener('DOMContentLoaded', async function() {
    showNotification('APK Store cargado correctamente', 'success');

    // Set up auth state listener
    _supabase.auth.onAuthStateChange((event, session) => {
        const user = session?.user || null;
        currentUser = user;
        updateUI();
        if (user) {
            console.log('User logged in:', user.email);
            checkAdminStatus();
        } else {
            console.log('User logged out');
        }
    });

    // Initialize other components
    loadApps();
    loadStatistics();
    setupFormListeners();
    setupSearchListeners();
    setupDragAndDrop();
    setupFileInputs();
    setupNetworkHandlers();
});

function updateUI() {
    const authButtons = document.getElementById('authButtons');
    const userProfile = document.getElementById('userProfile');
    const uploadButton = document.querySelector('#userProfile .btn-primary');

    if (currentUser) {
        authButtons.style.display = 'none';
        userProfile.style.display = 'flex';
        document.getElementById('userName').textContent = (currentUser.user_metadata.name || currentUser.email);
        document.getElementById('userAvatar').textContent = (currentUser.user_metadata.name || currentUser.email).charAt(0).toUpperCase();

        // Show/hide Upload button based on admin status
        if (currentUser.isAdmin) {
            uploadButton.style.display = 'inline-flex';
        } else {
            uploadButton.style.display = 'none';
        }

    } else {
        authButtons.style.display = 'flex';
        userProfile.style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
    }
}

async function checkAdminStatus() {
    if (!currentUser) return;

    if (currentUser.email === 'sanjuanazuara@gmail.com') {
        currentUser.isAdmin = true;
        document.getElementById('adminPanel').style.display = 'block';
        loadAdminApps();
    } else {
        currentUser.isAdmin = false;
        document.getElementById('adminPanel').style.display = 'none';
    }
    updateUI(); // Re-render UI to show/hide admin elements
}

async function loadStatistics() {
    try {
        document.getElementById('statsBar').style.display = 'flex';
        
        const appsSnapshot = await db.collection('apps').where('approved', '==', true).get();
        const approvedApps = appsSnapshot.docs.map(doc => doc.data());

        const usersSnapshot = await db.collection('users').get();
        
        document.getElementById('totalApps').textContent = approvedApps.length;
        document.getElementById('totalDownloads').textContent = approvedApps.reduce((sum, app) => sum + (app.downloads || 0), 0);
        document.getElementById('totalUsers').textContent = usersSnapshot.size;
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

function setupFormListeners() {
    // Login form
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        
        if (!email || !password) {
            showNotification('Por favor completa todos los campos', 'error');
            return;
        }
        
        try {
            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
            closeModal('loginModal');
            showNotification('Sesión iniciada correctamente', 'success');
            document.getElementById('loginForm').reset();
        } catch (error) {
            console.error('Login error:', error);
            handleAuthError(error, 'login');
        }
    });

    // Register form
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const name = document.getElementById('registerName').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value;
        
        if (!name || !email || !password) {
            showNotification('Por favor completa todos los campos', 'error');
            return;
        }
        
        if (password.length < 6) {
            showNotification('La contraseña debe tener al menos 6 caracteres', 'error');
            return;
        }
        
        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            await userCredential.user.updateProfile({ displayName: name });
            
            // Create user document
            await db.collection('users').doc(userCredential.user.uid).set({
                name: name,
                email: email,
                isAdmin: false,
                createdAt: new Date()
            });
            
            closeModal('registerModal');
            showNotification('Cuenta creada correctamente', 'success');
            document.getElementById('registerForm').reset();
            loadStatistics();
        } catch (error) {
            console.error('Register error:', error);
            handleAuthError(error, 'register');
        }
    });

    // Upload form
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (uploadInProgress) return;

        const form = e.target;
        const editingAppId = form.dataset.editingAppId;

        if (editingAppId) {
            await updateApp(editingAppId);
        } else {
            await uploadApp();
        }
    });
}

function handleAuthError(error, context) {
    let errorMessage = 'Error desconocido';
    
    switch (error.code) {
        case 'auth/user-not-found':
            errorMessage = 'Usuario no encontrado';
            break;
        case 'auth/wrong-password':
            errorMessage = 'Contraseña incorrecta';
            break;
        case 'auth/invalid-email':
            errorMessage = 'Email inválido';
            break;
        case 'auth/email-already-in-use':
            errorMessage = 'Este email ya está registrado';
            break;
        case 'auth/weak-password':
            errorMessage = 'La contraseña es muy débil';
            break;
        case 'auth/network-request-failed':
            errorMessage = 'Error de conexión. Verifica tu internet';
            break;
        default:
            errorMessage = error.message || 'Error de autenticación';
    }
    
    showNotification(errorMessage, 'error');
}

function setupFileInputs() {
    // Icon file input
    document.getElementById('iconFile').addEventListener('change', function(e) {
        handleFileSelection(e, 'icon');
    });

    // APK file input
    document.getElementById('apkFile').addEventListener('change', function(e) {
        handleFileSelection(e, 'apk');
    });
}

function handleFileSelection(event, type) {
    const file = event.target.files[0];
    const uploadArea = document.getElementById(type + 'UploadArea');
    const fileInfo = document.getElementById(type + 'FileInfo');
    
    if (file) {
        let isValid = true;
        let errorMessage = '';
        
        if (type === 'icon') {
            if (!file.type.startsWith('image/')) {
                isValid = false;
                errorMessage = 'Solo se permiten archivos de imagen para el icono';
            } else if (file.size > 2 * 1024 * 1024) {
                isValid = false;
                errorMessage = 'El icono es demasiado grande (máximo 2MB)';
            }
        } else if (type === 'apk') {
            if (!file.name.toLowerCase().endsWith('.apk')) {
                isValid = false;
                errorMessage = 'Solo se permiten archivos .apk';
            } else if (file.size > 50 * 1024 * 1024) {
                isValid = false;
                errorMessage = 'El archivo APK es demasiado grande (máximo 50MB)';
            }
        }
        
        if (!isValid) {
            showNotification(errorMessage, 'error');
            event.target.value = '';
            uploadArea.classList.remove('has-file');
            fileInfo.style.display = 'none';
            return;
        }
        
        uploadArea.classList.add('has-file');
        fileInfo.style.display = 'block';
        fileInfo.innerHTML = `<i class="fas fa-check"></i> ${file.name} (${formatFileSize(file.size)})`;
    } else {
        uploadArea.classList.remove('has-file');
        fileInfo.style.display = 'none';
    }
}

function triggerFileInput(inputId) {
    if (!uploadInProgress) {
        document.getElementById(inputId).click();
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function setupSearchListeners() {
    document.getElementById('searchInput').addEventListener('input', debounce(searchApps, 300));
    document.getElementById('categoryFilter').addEventListener('change', searchApps);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function searchApps() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    let filteredApps = allApps;
    
    if (searchTerm) {
        filteredApps = filteredApps.filter(app =>
            (app.name || '').toLowerCase().includes(searchTerm) ||
            (app.description || '').toLowerCase().includes(searchTerm)
        );
    }
    if (category) {
        filteredApps = filteredApps.filter(app => app.category === category);
    }
    displayApps(filteredApps);
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    displayApps(allApps);
}

async function loadApps() {
    try {
        console.log('Loading apps...');
        const snapshot = await db.collection('apps')
            .where('approved', '==', true)
            .orderBy('createdAt', 'desc')
            .get();
        
        allApps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        console.log('Apps loaded:', allApps.length);
        displayApps(allApps);
        loadStatistics();
    } catch (error) {
        console.error('Error loading apps:', error);
        document.getElementById('appsGrid').innerHTML = 
            '<p style="text-align: center; color: #666;">Error al cargar las aplicaciones. Verifica tu conexión.</p>';
    }
}

function displayApps(apps) {
    const appsGrid = document.getElementById('appsGrid');
    if (!apps || apps.length === 0) {
        appsGrid.innerHTML = '<p style="text-align: center; color: #666;">No se encontraron aplicaciones</p>';
        return;
    }
    
    appsGrid.innerHTML = apps.map(app => `
        <div class="app-card" onclick="showAppDetail('${app.id}')">
            <div class="app-header">
                <div class="app-icon">
                    <img src="${app.iconUrl || ''}" style="width: 100%; height: 100%; border-radius: 15px; object-fit: cover;" alt="${escapeHtml(app.name)}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <i class="fas fa-mobile-alt" ${app.iconUrl ? 'style="display: none;"' : ''}></i>
                </div>
                <div class="app-info">
                    <h3>${escapeHtml(app.name)}</h3>
                    <span class="app-category">${escapeHtml(app.category)}</span>
                </div>
            </div>
            <div class="app-description">${escapeHtml(app.description)}</div>
            <div class="app-stats">
                <div class="stat">
                    <i class="fas fa-download"></i>
                    <span>${app.downloads || 0} descargas</span>
                </div>
                <div class="stat">
                    <i class="fas fa-tag"></i>
                    <span>v${escapeHtml(app.version)}</span>
                </div>
            </div>
            <button class="download-btn" onclick="event.stopPropagation(); downloadApp('${app.id}')">
                <i class="fas fa-download"></i>
                Descargar
            </button>
        </div>
    `).join('');
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

async function uploadApp() {
    if (!currentUser || !currentUser.isAdmin) {
        showNotification('No tienes permiso para subir aplicaciones.', 'error');
        return;
    }

    // Get form values
    const name = document.getElementById('appName').value.trim();
    const description = document.getElementById('appDescription').value.trim();
    const category = document.getElementById('appCategory').value;
    const version = document.getElementById('appVersion').value.trim();
    const iconFile = document.getElementById('iconFile').files[0];
    const apkFile = document.getElementById('apkFile').files[0];

    // Comprehensive validation
    if (!validateUploadForm(name, description, category, version, apkFile)) {
        return;
    }

    // Set upload state
    uploadInProgress = true;
    setUploadState(true);

    try {
        let iconUrl = null;

        // Upload icon if provided
        if (iconFile) {
            iconUrl = await uploadFileWithProgress(iconFile, 'icons', (progress) => {
                updateUploadStatus(`Subiendo icono... ${Math.round(progress)}%`, progress * 0.3);
            });
            if (!iconUrl) {
                throw new Error('Error al subir el icono');
            }
        }

        // Upload APK
        const apkUrl = await uploadFileWithProgress(apkFile, 'apks', (progress) => {
            updateUploadStatus(`Subiendo APK... ${Math.round(progress)}%`, 30 + (progress * 0.5));
        });
        if (!apkUrl) {
            throw new Error('Error al subir el archivo APK');
        }

        // Save to database
        updateUploadStatus('Guardando información...', 90);
        
        const appData = {
            name: name,
            description: description,
            category: category,
            version: version,
            iconUrl: iconUrl,
            apkUrl: apkUrl,
            uploadedBy: currentUser.uid,
            uploaderName: currentUser.displayName || currentUser.email,
            approved: false,
            downloads: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            fileSize: apkFile.size,
            fileName: apkFile.name
        };

        await db.collection('apps').add(appData);

        // Complete upload
        updateUploadStatus('¡Subida completada!', 100);
        
        setTimeout(() => {
            closeModal('uploadModal');
            resetUploadForm();
            showNotification('Aplicación subida correctamente. Pendiente de aprobación por un administrador.', 'success');
            loadAdminApps(); // Refresh admin panel if visible
        }, 1500);

    } catch (error) {
        console.error('Upload error:', error);
        handleUploadError(error);
        resetUploadForm();
    }
}

async function updateApp(appId) {
    const name = document.getElementById('appName').value.trim();
    const description = document.getElementById('appDescription').value.trim();
    const category = document.getElementById('appCategory').value;
    const version = document.getElementById('appVersion').value.trim();

    // Basic validation
    if (!name || !description || !category || !version) {
        showNotification('Por favor completa todos los campos', 'error');
        return;
    }

    const uploadBtn = document.getElementById('uploadBtn');
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';

    try {
        const appRef = db.collection('apps').doc(appId);
        await appRef.update({
            name,
            description,
            category,
            version,
        });
        
        closeModal('uploadModal');
        showNotification('Aplicación actualizada correctamente', 'success');
        
        // Refresh views
        loadAdminApps();
        loadApps();
        loadStatistics();

    } catch (error) {
        console.error('Error updating app:', error);
        showNotification('Error al actualizar la aplicación', 'error');
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
    }
}

function validateUploadForm(name, description, category, version, apkFile) {
    if (!name || !description || !category || !version) {
        showNotification('Por favor completa todos los campos obligatorios', 'error');
        return false;
    }

    if (name.length > 100) {
        showNotification('El nombre es demasiado largo (máximo 100 caracteres)', 'error');
        return false;
    }

    if (description.length > 500) {
        showNotification('La descripción es demasiado larga (máximo 500 caracteres)', 'error');
        return false;
    }

    // Validate version format (flexible)
    const versionRegex = /^\d+(\.\d+)*$/;
    if (!versionRegex.test(version)) {
        showNotification('Formato de versión inválido. Usa números separados por puntos (ej: 1.0.0)', 'error');
        return false;
    }

    const form = document.getElementById('uploadForm');
    if (!form.dataset.editingAppId && !apkFile) {
        showNotification('Debes seleccionar un archivo APK', 'error');
        return false;
    }

    return true;
}

async function uploadFileWithProgress(file, folder, progressCallback) {
    return new Promise((resolve, reject) => {
        const timestamp = Date.now();
        const fileName = `${timestamp}_${file.name}`;
        const path = `${folder}/${currentUser.uid}/${fileName}`;
        const uploadTask = storage.ref(path).put(file);

        uploadTask.on('state_changed',
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                if (progressCallback) {
                    progressCallback(progress);
                }
            },
            (error) => {
                console.error(`Error uploading ${folder}:`, error);
                reject(error);
            },
            async () => {
                try {
                    const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                    resolve(downloadURL);
                } catch (error) {
                    reject(error);
                }
            }
        );
    });
}

function updateUploadStatus(message, progress) {
    document.getElementById('uploadStatus').textContent = message;
    document.getElementById('progressFill').style.width = `${progress}%`;
}

function setUploadState(uploading) {
    const uploadBtn = document.getElementById('uploadBtn');
    const progressContainer = document.getElementById('uploadProgress');
    
    if (uploading) {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
        progressContainer.style.display = 'block';
        updateUploadStatus('Preparando subida...', 0);
    } else {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Subir Aplicación';
        progressContainer.style.display = 'none';
    }
}

function handleUploadError(error) {
    let errorMessage = 'Error al subir la aplicación';
    
    if (error.code) {
        switch (error.code) {
            case 'storage/unauthorized':
                errorMessage = 'No tienes permisos para subir archivos';
                break;
            case 'storage/canceled':
                errorMessage = 'Subida cancelada';
                break;
            case 'storage/quota-exceeded':
                errorMessage = 'Cuota de almacenamiento excedida';
                break;
            case 'storage/retry-limit-exceeded':
                errorMessage = 'Error de conexión. Intenta nuevamente';
                break;
            case 'storage/invalid-format':
                errorMessage = 'Formato de archivo no válido';
                break;
            default:
                errorMessage = `Error: ${error.message}`;
        }
    } else if (error.message) {
        errorMessage = error.message;
    }
    
    showNotification(errorMessage, 'error');
}

function resetUploadForm() {
    uploadInProgress = false;
    setUploadState(false);
    
    const form = document.getElementById('uploadForm');
    form.reset();
    delete form.dataset.editingAppId;

    document.getElementById('iconUploadArea').classList.remove('has-file');
    document.getElementById('apkUploadArea').classList.remove('has-file');
    document.getElementById('iconFileInfo').style.display = 'none';
    document.getElementById('apkFileInfo').style.display = 'none';

    document.getElementById('iconFile').required = true;
    document.getElementById('apkFile').required = true;
    document.getElementById('iconUploadArea').style.display = 'block';
    document.getElementById('apkUploadArea').style.display = 'block';
    document.querySelector('#uploadModal h2').textContent = 'Subir Nueva Aplicación';
    document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-upload"></i> Subir Aplicación';
}

async function showAppDetail(appId) {
    const app = allApps.find(a => a.id === appId);
    if (!app) return;

    const content = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="width: 100px; height: 100px; margin: 0 auto 20px; border-radius: 20px; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">
                <img src="${app.iconUrl || ''}" style="width: 100%; height: 100%; border-radius: 20px; object-fit: cover;" alt="${escapeHtml(app.name)}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <i class="fas fa-mobile-alt" ${app.iconUrl ? 'style="display: none;"' : ''}></i>
            </div>
            <h2>${escapeHtml(app.name)}</h2>
            <span class="app-category" style="font-size: 1rem; padding: 8px 16px;">${escapeHtml(app.category)}</span>
        </div>
        <div style="margin-bottom: 20px;">
            <h3 style="margin-bottom: 10px;">Descripción</h3>
            <p style="line-height: 1.6; color: #666;">${escapeHtml(app.description)}</p>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <strong>Versión:</strong> ${escapeHtml(app.version)}
            </div>
            <div>
                <strong>Descargas:</strong> ${app.downloads || 0}
            </div>
            <div>
                <strong>Subido por:</strong> ${escapeHtml(app.uploaderName)}
            </div>
            <div>
                <strong>Fecha:</strong> ${app.createdAt ? new Date(app.createdAt.seconds * 1000).toLocaleDateString('es-ES') : 'N/A'}
            </div>
            ${app.fileSize ? `
            <div>
                <strong>Tamaño:</strong> ${formatFileSize(app.fileSize)}
            </div>
            ` : ''}
        </div>
        <button class="btn btn-primary" style="width: 100%; font-size: 1.1rem; padding: 15px;" onclick="downloadApp('${app.id}')">
            <i class="fas fa-download"></i>
            Descargar
        </button>
    `;
    const detailContent = document.getElementById('appDetailContent');
    detailContent.innerHTML = content;

    document.getElementById('appDetailModal').style.display = 'flex';
}

async function downloadApp(appId) {
    try {
        const app = allApps.find(a => a.id === appId);
        if (!app || !app.apkUrl) {
            showNotification('Error: No se pudo encontrar el archivo APK', 'error');
            return;
        }

        showNotification('Iniciando descarga...', 'info');

        await db.collection('apps').doc(appId).update({
            downloads: firebase.firestore.FieldValue.increment(1)
        });

        const appIndex = allApps.findIndex(a => a.id === appId);
        if(appIndex !== -1) {
            allApps[appIndex].downloads = (allApps[appIndex].downloads || 0) + 1;
        }
        
        displayApps(allApps);
        loadStatistics();
        
        window.open(app.apkUrl, '_blank');
        
    } catch (error) {
        console.error('Download error:', error);
        showNotification('Error al iniciar la descarga', 'error');
    }
}

async function loadAdminApps() {
    try {
        const snapshot = await db.collection('apps').orderBy('createdAt', 'desc').get();
        const adminApps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayAdminApps(adminApps);
    } catch (error) {
        console.error('Error loading admin apps:', error);
        document.getElementById('adminApps').innerHTML = 
            '<p style="text-align: center; color: #666;">Error al cargar aplicaciones</p>';
    }
}

function displayAdminApps(apps) {
    const adminAppsContainer = document.getElementById('adminApps');
    if (!apps || apps.length === 0) {
        adminAppsContainer.innerHTML = '<p style="text-align: center; color: #666;">No hay aplicaciones</p>';
        return;
    }
    
    adminAppsContainer.innerHTML = apps.map(app => `
        <div class="admin-app-item">
            <div class="admin-app-info">
                <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white;">
                    <img src="${app.iconUrl || ''}" style="width: 100%; height: 100%; border-radius: 10px; object-fit: cover;" alt="${escapeHtml(app.name)}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <i class="fas fa-mobile-alt" ${app.iconUrl ? 'style="display: none;"' : ''}></i>
                </div>
                <div>
                    <strong>${escapeHtml(app.name)}</strong>
                    <br>
                    <small style="color: #666;">
                        ${escapeHtml(app.category)} | v${escapeHtml(app.version)} | ${escapeHtml(app.uploaderName)}
                        <br>
                        Estado: ${app.approved ? '✅ Aprobada' : '⏳ Pendiente'} | Descargas: ${app.downloads || 0}
                        ${app.fileSize ? ` | ${formatFileSize(app.fileSize)}` : ''}
                    </small>
                </div>
            </div>
            <div class="admin-actions">
                <button class="btn btn-primary" onclick="downloadApp('${app.id}')">
                    <i class="fas fa-download"></i>
                    Descargar
                </button>
                ${!app.approved ? `
                    <button class="btn btn-success" onclick="approveApp('${app.id}')">
                        <i class="fas fa-check"></i>
                        Aprobar
                    </button>
                ` : ''}
                <button class="btn btn-warning" onclick="showEditModal('${app.id}')">
                    <i class="fas fa-edit"></i>
                    Editar
                </button>
                <button class="btn btn-danger" onclick="deleteApp('${app.id}')">
                    <i class="fas fa-trash"></i>
                    Eliminar
                </button>
            </div>
        </div>
    `).join('');
}

function showEditModal(appId) {
    const app = allApps.find(a => a.id === appId) || adminApps.find(a => a.id === appId);
    if (!app) {
        showNotification('No se pudo encontrar la aplicación para editar', 'error');
        return;
    }

    const form = document.getElementById('uploadForm');
    form.dataset.editingAppId = appId;

    document.getElementById('appName').value = app.name;
    document.getElementById('appDescription').value = app.description;
    document.getElementById('appCategory').value = app.category;
    document.getElementById('appVersion').value = app.version;
    
    // Disable file inputs for editing
    document.getElementById('iconFile').required = false;
    document.getElementById('apkFile').required = false;
    document.getElementById('iconUploadArea').style.display = 'none';
    document.getElementById('apkUploadArea').style.display = 'none';

    document.querySelector('#uploadModal h2').textContent = 'Editar Aplicación';
    document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';

    showUploadModal();
}

async function approveApp(appId) {
    try {
        await db.collection('apps').doc(appId).update({ approved: true });
        showNotification('Aplicación aprobada correctamente', 'success');
        loadAdminApps();
        loadApps(); // Refresh public apps
        loadStatistics();
    } catch (error) {
        console.error('Error approving app:', error);
        showNotification('Error al aprobar la aplicación', 'error');
    }
}

async function deleteApp(appId) {
    if (!currentUser || !currentUser.isAdmin) {
        showNotification('No tienes permiso para eliminar aplicaciones.', 'error');
        return;
    }

    if (!confirm('¿Estás seguro de que quieres eliminar esta aplicación? Esta acción no se puede deshacer.')) {
        return;
    }

    try {
        const appDoc = await db.collection('apps').doc(appId).get();
        if (!appDoc.exists) {
            showNotification('La aplicación no existe', 'error');
            return;
        }
        
        const appData = appDoc.data();

        // Delete files from storage (non-blocking)
        if (appData.iconUrl) {
            try {
                const iconRef = storage.refFromURL(appData.iconUrl);
                await iconRef.delete();
            } catch (e) {
                console.warn('Could not delete icon file:', e);
            }
        }

        if (appData.apkUrl) {
            try {
                const apkRef = storage.refFromURL(appData.apkUrl);
                await apkRef.delete();
            } catch (e) {
                console.warn('Could not delete APK file:', e);
            }
        }

        // Delete document
        await db.collection('apps').doc(appId).delete();
        
        showNotification('Aplicación eliminada correctamente', 'success');
        loadAdminApps();
        loadApps(); // Refresh public apps
        loadStatistics();
        
    } catch (error) {
        console.error('Error deleting app:', error);
        showNotification('Error al eliminar la aplicación', 'error');
    }
}

// Modal functions
function showLoginModal() {
    document.getElementById('loginModal').style.display = 'flex';
}

function showRegisterModal() {
    // Registration is disabled
    showNotification('El registro de nuevos usuarios está deshabilitado.', 'info');
    // document.getElementById('registerModal').style.display = 'flex';
}

function showUploadModal() {
    if (!currentUser) {
        showNotification('Debes iniciar sesión para subir apps', 'error');
        return;
    }
    document.getElementById('uploadModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    if (modalId === 'uploadModal') {
        resetUploadForm();
    }
}

function logout() {
    if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
        auth.signOut().then(() => {
            showNotification('Sesión cerrada correctamente', 'success');
            window.location.reload();
        }).catch((error) => {
            console.error('Logout error:', error);
            showNotification('Error al cerrar sesión', 'error');
        });
    }
}

function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type} show`;
    
    // Auto-hide after delay
    setTimeout(() => {
        notification.classList.remove('show');
    }, type === 'error' ? 5000 : 4000);
}

function setupNetworkHandlers() {
    // Handle online/offline status
    window.addEventListener('online', function() {
        document.getElementById('offlineMode').style.display = 'none';
        showNotification('Conexión restablecida', 'success');
        loadApps(); // Reload apps when back online
    });

    window.addEventListener('offline', function() {
        document.getElementById('offlineMode').style.display = 'block';
        showNotification('Sin conexión a internet', 'error');
    });

    // Check initial connection status
    if (!navigator.onLine) {
        document.getElementById('offlineMode').style.display = 'block';
    }
}

// Setup drag and drop
function setupDragAndDrop() {
    const uploadAreas = document.querySelectorAll('.upload-area');
    
    uploadAreas.forEach(area => {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            area.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            area.addEventListener(eventName, () => {
                if (!uploadInProgress) {
                    area.classList.add('dragover');
                }
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            area.addEventListener(eventName, () => {
                area.classList.remove('dragover');
            }, false);
        });

        area.addEventListener('drop', handleDrop, false);
    });
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function handleDrop(e) {
    if (uploadInProgress) return;
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        const area = e.target.closest('.upload-area');
        const fileInput = area.parentElement.querySelector('input[type="file"]');
        
        if (fileInput) {
            // Validate file type
            if (fileInput.id === 'iconFile' && !file.type.startsWith('image/')) {
                showNotification('Solo se permiten archivos de imagen para el icono', 'error');
                return;
            }
            if (fileInput.id === 'apkFile' && !file.name.toLowerCase().endsWith('.apk')) {
                showNotification('Solo se permiten archivos .apk', 'error');
                return;
            }
            
            // Set file
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            fileInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }
}

// Event Listeners
window.addEventListener('click', function(e) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (e.target === modal) {
            closeModal(modal.id);
        }
    });
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const openModals = document.querySelectorAll('.modal[style*="flex"]');
        openModals.forEach(modal => {
            closeModal(modal.id);
        });
    }
    
    // Search shortcut (Ctrl/Cmd + F)
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
    }
});

// Search on Enter
document.getElementById('searchInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchApps();
    }
});

// Auto-save form data
function setupAutoSave() {
    const forms = ['loginForm', 'registerForm'];
    forms.forEach(formId => {
        const form = document.getElementById(formId);
        const inputs = form.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                if (input.type !== 'password') {
                    localStorage.setItem(`${formId}_${input.id}`, input.value);
                }
            });
            
            // Restore saved values
            const savedValue = localStorage.getItem(`${formId}_${input.id}`);
            if (savedValue && input.type !== 'password') {
                input.value = savedValue;
            }
        });
    });
}

// Call auto-save setup
document.addEventListener('DOMContentLoaded', function() {
    setupAutoSave();
});

// Add loading states for better UX
function showLoading(element, text = 'Cargando...') {
    element.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
            <div class="spinner" style="width: 20px; height: 20px;"></div>
            <span>${text}</span>
        </div>
    `;
}

// Add error boundaries
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    showNotification('Ha ocurrido un error inesperado', 'error');
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('Unhandled promise rejection:', e.reason);
    // Evitar que se muestre la notificación genérica para poder depurar el error real.
    // showNotification('Error de conexión o procesamiento', 'error');
});

// Add performance monitoring
function logPerformance() {
    if ('performance' in window) {
        window.addEventListener('load', function() {
            setTimeout(function() {
                const perfData = performance.getEntriesByType('navigation')[0];
                console.log('Page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
            }, 0);
        });
    }
}

logPerformance();


// Add touch/swipe support for mobile
function addTouchSupport() {
    let startX, startY;
    
    document.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    });
    
    document.addEventListener('touchend', function(e) {
        if (!startX || !startY) return;
        
        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;
        
        const diffX = startX - endX;
        const diffY = startY - endY;
        
        // Swipe right to close modals
        if (Math.abs(diffX) > Math.abs(diffY) && diffX < -100) {
            const openModal = document.querySelector('.modal[style*="flex"]');
            if (openModal) {
                closeModal(openModal.id);
            }
        }
        
        startX = null;
        startY = null;
    });
}

addTouchSupport();

// Add accessibility improvements
function addAccessibilityFeatures() {
    // Add ARIA labels and roles
    document.querySelectorAll('.btn').forEach(btn => {
        if (!btn.getAttribute('aria-label')) {
            btn.setAttribute('aria-label', btn.textContent.trim());
        }
    });
    
    // Add focus management for modals
    document.querySelectorAll('.modal').forEach(modal => {
        modal.setAttribute('role', 'dialog');
        modal.setAttribute('aria-modal', 'true');
    });
    
    // Add keyboard navigation for cards
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.classList.contains('app-card')) {
            e.target.click();
        }
    });
}

document.addEventListener('DOMContentLoaded', addAccessibilityFeatures);

// Export functions for testing (if needed)
window.APKStore = {
    searchApps,
    clearSearch,
    showNotification,
    formatFileSize,
    escapeHtml,
    validateUploadForm
};

console.log('APK Store initialized successfully!');
    </script>
</body>
</html>
